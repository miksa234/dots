#!/usr/bin/env zsh


stop() {
#    vpn stop
	pgrep transmission | xargs kill -9
	notify-send "Transmission" "Stopped"
}

finish() {
	# notifies me when torrent finished downloading and then remove it so it doenst seed

	file=$(transmission-remote -l | grep 100% | awk '{printf $10}')
	confirm=$(printf "yes\nno" | dmenu -p "Remove Torrent $file ?" )
	if [[ $confirm == "yes" ]]; then
		transmission-remote -l |\
			awk '$2 == "100%"{ system("transmission-remote -t " $1 " --remove") }' &&\
			notify-send "Torrent finished downloading" "$file"
	fi

}

start() {
	var=$(nmcli | grep wlp3s0:\ connect | awk '{printf $4}')
    transmission-daemon -g /home/mika/.config/transmission-daemon/ --foreground --log-info 2<&1 |\
    while read line; do
            echo $line |\
                grep -v "announcer.c:\|platform.c:\|announce done (tr-dht.c:" |\
                grep -v "Saved.*variant.c:" |\
                while read line; do
                    echo $line | grep -q started &&\
                    notify-send "Transmission Started" " "
                    echo $line | systemd-cat --identifier="TransWrap" --priority=5
                done 2>&1 > /dev/null
        done&disown;
        exit 0
}

restart() {
	trm stop && trm start
}

magnet() {
	LINK="$1"

	if [ -z "$LINK" ]; then
	  notify-send "Error" "need magnet link"
	fi

	HOST="localhost"
	PORT="9091"

	ss -tuna | grep 9091 || trm start &&\
	confirm=$(printf "yes\nno" | dmenu -p "Add torrent?" )

	if [[ $confirm == "yes" ]]; then
			SESSID=$(curl "http://$HOST:$PORT/transmission/rpc" | sed 's/.*<code>//g;s/<\/code>.*//g')
			add=$(curl --silent --header "$SESSID" \
						"http://$HOST:$PORT/transmission/rpc"\
						-d "{\"method\":\"torrent-add\",\"arguments\":{\"filename\":\"${LINK}\"}}")

			name=$(echo $add | jq -r '.arguments[].name') &&\
			notify-send  "Succsess File" "$name downloading" ||\
			notify-send  "Error" "something went wrong"
	fi
}

"$@"
